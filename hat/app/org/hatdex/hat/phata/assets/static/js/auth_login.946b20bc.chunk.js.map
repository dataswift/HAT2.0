{"version":3,"sources":["features/authentication/AuthLogin.tsx"],"names":["AuthLogin","parentApp","useSelector","selectApplicationHmi","parentAppState","selectApplicationHmiState","messages","selectMessages","useState","password","setPassword","hatName","setHatName","errorMessage","setErrorMessage","history","useHistory","location","useLocation","dispatch","useDispatch","targetParam","queryString","window","search","target","state","from","query","repeat","email","applicationId","redirectUri","loginSuccessful","isDataswiftWebsite","toString","includes","replace","href","origin","useEffect","host","hostname","hatSvc","HatClientService","getInstance","substring","indexOf","token","Cookies","get","isTokenExpired","loginWithToken","login","a","userAccessToken","res","parsedBody","accessToken","secure","protocol","set","expires","sameSite","getApplicationHmi","setAppsHmiState","className","src","info","graphics","logo","normal","alt","name","id","asHtml","type","placeholder","autoComplete","value","hasError","onChange","e","disabled","length","onClick","to","config","links","hatters"],"mappings":"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","file":"static/js/auth_login.946b20bc.chunk.js","sourcesContent":["import React, { useEffect, useState } from 'react';\nimport './AuthLogin.scss';\nimport { Link, useHistory, useLocation } from 'react-router-dom';\nimport { useDispatch, useSelector } from 'react-redux';\nimport Cookies from 'js-cookie';\nimport * as queryString from 'query-string';\nimport { HatClientService } from '../../services/HatClientService';\nimport { loginWithToken } from './authenticationSlice';\nimport { userAccessToken } from '../../api/hatAPI';\nimport { AuthApplicationLogo, Input } from 'hmi';\nimport {\n  getApplicationHmi,\n  selectApplicationHmi,\n  selectApplicationHmiState,\n  setAppsHmiState,\n} from '../applications/applicationsSlice';\nimport { config } from '../../app.config';\nimport FormatMessage from '../messages/FormatMessage';\nimport { selectMessages } from '../messages/messagesSlice';\n\ntype Query = {\n  target?: string;\n};\n\ntype QueryLocationState = {\n  repeat?: string;\n  email?: string;\n  applicationId?: string;\n  redirectUri?: string;\n};\n\nconst AuthLogin: React.FC = () => {\n  const parentApp = useSelector(selectApplicationHmi);\n  const parentAppState = useSelector(selectApplicationHmiState);\n  const messages = useSelector(selectMessages);\n  const [password, setPassword] = useState('');\n  const [hatName, setHatName] = useState('');\n  const [errorMessage, setErrorMessage] = useState('');\n  let history = useHistory();\n  let location = useLocation<{ from?: string; query: QueryLocationState }>();\n  const dispatch = useDispatch();\n  const { target } = queryString.parse(window.location.search) as Query;\n  const targetParam = target || '/feed';\n\n  const { from, query } = location?.state || {};\n  const { repeat, email, applicationId, redirectUri } = query || {};\n\n  const loginSuccessful = () => {\n    // This is a hack and ideally should be removed. This is what allows the log in via dataswift.io webpage,\n    // without this check users are redirected back to the dataswift.io page with the token attached. The problem\n    // is that the dataswift.io page has no idea what to do with the token and uses are stuck there. With this hack\n    // users are being redirected back to their PDA Dashboard which is the intended behaviour.\n    const isDataswiftWebsite = (from?.search.toString().includes(\"www.dataswift.io%2Fsign-up-login\"));\n    if (from && !isDataswiftWebsite) {\n      history.replace(from);\n    } else {\n      window.location.href = window.location.origin + '/#' + targetParam;\n    }\n  };\n\n  useEffect(() => {\n    const host = window.location.hostname;\n    const hatSvc = HatClientService.getInstance();\n\n    setHatName(host.substring(0, host.indexOf('.')));\n\n    const token = Cookies.get('token');\n\n    if (token && !hatSvc.isTokenExpired(token)) {\n      dispatch(loginWithToken(token));\n      HatClientService.getInstance(token);\n\n      loginSuccessful();\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  const login = async () => {\n    setErrorMessage('');\n\n    try {\n      const res = await userAccessToken(hatName, password);\n\n      if (res.parsedBody) {\n        dispatch(loginWithToken(res.parsedBody.accessToken));\n        HatClientService.getInstance(res.parsedBody.accessToken);\n\n        const secure = window.location.protocol === 'https:';\n\n        // TODO ensure that this is fine to do\n        Cookies.set('token', res.parsedBody.accessToken, { expires: 3, secure: secure, sameSite: 'strict' });\n\n        loginSuccessful();\n      }\n    } catch (e) {\n      if (messages) {\n        setErrorMessage(messages['ds.auth.login.passwordIncorrect']);\n      }\n    }\n  };\n\n  const navigateToSignup = () => {\n    if (applicationId && redirectUri) {\n      // eslint-disable-next-line max-len\n      window.location.href = `${config.links.hatters}/services/signup?application_id=${applicationId}&redirect_uri=${redirectUri}`;\n    } else {\n      window.location.href = `${config.links.hatters}/hat/signup`;\n    }\n  };\n\n  useEffect(() => {\n    if (applicationId && !parentApp) {\n      dispatch(getApplicationHmi(applicationId));\n    } else {\n      dispatch(setAppsHmiState('completed'));\n    }\n  }, [dispatch, parentApp, applicationId]);\n\n  return (\n    <div>\n      <div className={'flex-column-wrapper auth-login'}>\n        <AuthApplicationLogo\n          src={parentApp?.info.graphics.logo.normal}\n          alt={parentApp?.info.name}\n          state={parentAppState}\n        />\n\n        <h2 className={'ds-hmi-email auth-login-email-title'}>{email}</h2>\n\n        <h2 className={'auth-login-title'}>\n          <FormatMessage \n            id={repeat ? 'ds.auth.login.title.password.repeat' : 'ds.auth.login.title.password'} \n            asHtml\n          />\n        </h2>\n\n        <Input\n          type={'password'}\n          aria-label=\"password\"\n          placeholder={'Password'}\n          autoComplete={'password'}\n          id={'password'}\n          value={password}\n          hasError={!!errorMessage}\n          errorMessage={errorMessage}\n          onChange={(e) => setPassword(e.target.value)}\n        />\n\n        <button\n          aria-label=\"Next Button\"\n          className={'auth-login-btn ds-hmi-btn ds-hmi-btn-primary'}\n          disabled={password.length < 3}\n          onClick={() => login()}\n        >\n          <FormatMessage id={'ds.auth.nextBtn'} />\n        </button>\n\n        <Link className={'auth-login-btn-link'} to={'/auth/recover-password'}>\n          <FormatMessage id={'ds.auth.login.forgotPassword'} />\n        </Link>\n\n        <hr />\n\n        <p className={'auth-login-have-an-account'}>\n          <FormatMessage\n            id={repeat ? 'ds.auth.login.title.wantToCreateAccount' : 'ds.auth.login.title.dontHaveAnAccount'}\n          />\n        </p>\n\n        <button className={'auth-login-btn-signup ds-hmi-btn ds-hmi-btn-primary'} onClick={() => navigateToSignup()}>\n          <FormatMessage id={'ds.auth.signupBtn'} />\n        </button>\n      </div>\n    </div>\n  );\n};\n\nexport default AuthLogin;\n"],"sourceRoot":""}